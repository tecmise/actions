name: Checking Changes

on:
  workflow_call:
    inputs:
      paths:
        description: 'Paths to verify content'
        required: true
        type: string
    outputs:
      has_changes:
        value: ${{ jobs.building.outputs.md5 }}
        description: 'Content Hash'

jobs:
  loading-hash:
    name: Generating hashcode
    runs-on: ubuntu-latest
    outputs:
      content: ${{ steps.generate_hash.outputs.content }}
    steps:

    - name: Checkout script repository
      uses: actions/checkout@v4
      with:
        repository: 'tecmise/actions'
        path: code

    - id: generate_hash
      name: Generate Hash Token
      run: |
        hash=$(python code/.github/scripts/content_check.py "${{ inputs.paths }}")
        echo "content=$hash" >> $GITHUB_OUTPUT

    - name: Remove code directory
      run: rm -rf code

  checking-last-version:
    name: Checking current version
    runs-on: ubuntu-latest
    needs: loading-hash
    steps:

    - name: configure aws credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::${{ fromJson(vars.AWS_ACCOUNTS).s4s[github.ref_name] }}:role/github-actions-role
        role-session-name: github-actions-role
        aws-region: 'us-east-1'

    - name: "Generate Terraform file"
      shell: bash
      run: |
        aws ssm get-parameters-by-path --path "/versions/${{ github.event.repository.name }}" --region us-east-1 > parameters.json
        cat parameters.json