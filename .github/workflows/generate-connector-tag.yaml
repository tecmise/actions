name: "Publish Version"
on:
  workflow_call:
    secrets:
      CONNECTORS_KEY:
        required: true
      DISCORD_NOTIFIER_URL:
        required: true

jobs:

  loading_pr_data:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.keyword.outputs.result }}
      patch: ${{ steps.patch.outputs.version }}
      minor: ${{ steps.minor.outputs.version }}
      major: ${{ steps.major.outputs.version }}
    steps:
      - name: Checking out the repository
        id: keyword
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.CONNECTORS_KEY }}
          result-encoding: string
          script: |
            const prNumber = context.payload.pull_request.number;
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              per_page: 100
            });

            reviews.sort((a, b) =>
              new Date(b.submitted_at) - new Date(a.submitted_at)
            );

            let encontrou = false;
            for (const review of reviews) {
              const body = (review.body || '').toLowerCase();
              if (body.includes('major')) {
                return "major";
              }
              if (body.includes('minor')) {
                return "minor";
              }
            }
            return "patch";
      - name: Next Version
        run: |
          echo "Versionament: ${{ steps.keyword.outputs.result }}"

      - name: Checking versionament
        id: versionament
        env:
          GITHUB_TOKEN: ${{ secrets.CONNECTORS_KEY }}
        uses: tecmise/actions/.github/actions/versionament@main

      - name: Show versionament
        run: |
          echo "Major: ${{ steps.versionament.outputs.major }}"
          echo "Minor: ${{ steps.versionament.outputs.minor }}"
          echo "Patch: ${{ steps.versionament.outputs.patch }}"

      - name: Next Patch
        id: patch
        run: |
          PATCH="${{ steps.versionament.outputs.patch }}"
          if [ "${{ steps.keyword.outputs.result }}" == "patch" ]; then
            PATCH=$((PATCH + 1))
          elif [ "${{ steps.keyword.outputs.result }}" == "minor" ] || [ "${{ steps.keyword.outputs.result }}" == "major" ]; then
            PATCH=0
          fi
          echo "version=$PATCH" >> $GITHUB_OUTPUT

      - name: Next Minor
        id: minor
        run: |
          MINOR="${{ steps.versionament.outputs.minor }}"
          if [ "${{ steps.keyword.outputs.result }}" == "minor" ]; then
            MINOR=$((MINOR + 1))
          elif [ "${{ steps.keyword.outputs.result }}" == "major" ]; then
            MINOR=0
          fi
          echo "version=$MINOR" >> $GITHUB_OUTPUT

      - name: Next Major
        id: major
        run: |
          MAJOR="${{ steps.versionament.outputs.major }}"
          if [ "${{ steps.keyword.outputs.result }}" == "major" ]; then
            MAJOR=$((MAJOR + 1))
          fi
          echo "version=$MAJOR" >> $GITHUB_OUTPUT

      - name: Show final version
        run: |
          echo "Final Version: ${{ steps.major.outputs.version }}.${{ steps.minor.outputs.version }}.${{ steps.patch.outputs.version }}"


  genrate-version:
    name: "Generate Version"
    runs-on: ubuntu-latest
    needs: loading_pr_data
    steps:
      - name: Checkout completo com tags
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Create & Push Patch Tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git fetch --tags
          git remote set-url origin https://x-access-token:${{ secrets.CONNECTORS_KEY }}@github.com/tecmise/notification-service-connector-go.git

          git checkout master
          git pull origin master
          
          git tag -a "v${{ needs.loading_pr_data.outputs.major }}.${{ needs.loading_pr_data.outputs.minor }}.${{ needs.loading_pr_data.outputs.patch }}" -m "Release ${{ needs.loading_pr_data.outputs.major }}.${{ needs.loading_pr_data.outputs.minor }}.${{ needs.loading_pr_data.outputs.patch }}"
          git push origin "v${{ needs.loading_pr_data.outputs.major }}.${{ needs.loading_pr_data.outputs.minor }}.${{ needs.loading_pr_data.outputs.patch }}"
