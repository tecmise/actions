name: Generate Connectors

on:
  workflow_call:
    secrets:
      database_password:
        required: true
      DISCORD_NOTIFIER_URL:
        required: true

    inputs:
      name:
        description: 'Name of the connector'
        required: true
        type: string
        default: 'database'
      schema:
        description: 'Schema for the database'
        required: true
        type: string
      user:
        description: 'User for the database'
        required: true
        type: string
      endpoint:
        description: 'Endpoint for the connector'
        required: true
        type: string

      database_name:
        description: 'Database name'
        required: true
        type: string

      flyway_table:
        description: 'Flyway schema history table name'
        required: true
        type: string
        default: 'flyway_schema_history'
      migration_path:
        description: 'Path to the migration files'
        required: false
        type: string
        default: './migrations'
      drivers_path:
        description: 'Copy database drivers to Flyway container'
        required: false
        type: string
        default: ''
      debug:
        description: 'Enable debug mode'
        required: false
        type: boolean
        default: false

jobs:
  validate-migrations:
    name: Validating Migrations
    runs-on: ['infrastructure', 's4s', "self-hosted", "linux", "x64", "amazon"]
    outputs:
      is-valid: "${{ steps.validate.outputs.exit_code == '0' }}"
    container:
      image: flyway/flyway:latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Upload values
      if: ${{ inputs.debug == true }}
      run: |
        echo "üîç Valores de entrada:"
        echo "Name: ${{ inputs.name }}" >> content.log
        echo "Schema: ${{ inputs.schema }}" >> content.log
        echo "User: ${{ inputs.user }}" >> content.log
        echo "Endpoint: ${{ inputs.endpoint }}" >> content.log
        echo "Database Name: ${{ inputs.database_name }}" >> content.log
        echo "Flyway Table: ${{ inputs.flyway_table }}" >> content.log
        echo "Migration Path: ${{ inputs.migration_path }}" >> content.log
        echo "Drivers Path: ${{ inputs.drivers_path }}" >> content.log
        echo "Secret: ${{ secrets.database_password }}" >> content.log

    - name: Upload Secret
      if: ${{ inputs.debug == true }}
      uses: actions/upload-artifact@v4
      with:
        retention-days: 1
        name: debug-values-${{ inputs.name }}
        path: content.log

    - name: Copiar drivers para o Flyway
      if: inputs.drivers_path != ''
      run: |
        mkdir -p /flyway/drivers
        cp ./${{ inputs.drivers_path }}/* /flyway/drivers/

    - name: Validar SQLs com Flyway
      id: validate
      run: |
        echo "üîç Iniciando valida√ß√£o..."
        set +e
        VALIDATION_OUTPUT=$(flyway -url="${{ inputs.endpoint }}/${{ inputs.database_name }}" \
          -user="${{ inputs.user }}" \
          -password="${{ secrets.database_password }}" \
          -schemas="${{ inputs.schema }}" \
          -table="${{ inputs.flyway_table }}" \
          -ignoreMigrationPatterns="*:pending" \
          -connectRetries=60 \
          -locations="filesystem:${{ inputs.migration_path }}" \
          validate 2>&1)
        EXIT_CODE=$?
        echo "$VALIDATION_OUTPUT" > validation.log
        echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

    - name: Upload Validation Log
      uses: actions/upload-artifact@v4
      with:
        path: validation.log
        name: validation-log-${{ inputs.name }}

  send-notification-validate:
    name: Send Notification Validate Error
    runs-on: ['infrastructure', 's4s', "self-hosted", "linux", "x64", "amazon"]
    needs: validate-migrations
    if: needs.validate-migrations.outputs.is-valid == 'false'
    steps:

    - name: Download Validation Log
      uses: actions/download-artifact@v4
      with:
        name: validation-log-${{ inputs.name }}

    - name: Notify Error
      uses: tecmise/actions/.github/actions/discord-notifier@v4.4.0
      with:
        title: '‚ùå  Houve um erro ao validar migrations ‚ùå '
        message: "Falha na valida√ß√£o das migrations."
        severity: 'error'
        discord-webhook-url: "${{ secrets.DISCORD_NOTIFIER_URL }}"
        fields:
          name||"${{ inputs.name }}"
          table||"${{ inputs.flyway_table }}"

    - name: Send Log File
      run: |
        curl -X POST ${{ secrets.DISCORD_NOTIFIER_URL }} -F "file=@validation.log"

    - name: Throw Error
      run: |
        exit 1

  migrate:
    name: Migrating Database
    runs-on: ['infrastructure', 's4s', "self-hosted", "linux", "x64", "amazon"]
    if: needs.validate-migrations.outputs.is-valid == 'true'
    needs: validate-migrations
    outputs:
      is-valid: "${{ steps.migrate.outputs.exit_code == '0' }}"
    container:
      image: flyway/flyway:latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Copiar drivers para o Flyway
      if: inputs.drivers_path != ''
      run: |
        mkdir -p /flyway/drivers
        cp ./${{ inputs.drivers_path }}/* /flyway/drivers/

    - name: Migrate
      id: migrate
      run: |
        echo "üöÄ Rodando migra√ß√µes..."
        set +e
        MIGRATION_OUTPUT=$(flyway -url="${{ inputs.endpoint }}/${{ inputs.database_name }}" \
          -user="${{ inputs.user }}" \
          -password="${{ secrets.database_password }}" \
          -ignoreMigrationPatterns="*:pending" \
          -table="${{ inputs.flyway_table }}" \
          -connectRetries=60 \
          -locations="filesystem:${{ inputs.migration_path }}" \
          -baselineOnMigrate=true \
          migrate 2>&1)
        EXIT_CODE=$?
        echo "$MIGRATION_OUTPUT" > migration.log
        echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

    - name: Upload Validation Log
      uses: actions/upload-artifact@v4
      with:
        path: migration.log
        name: migration-log

  send-notification-migrate-error:
    name: Notify Error
    runs-on: ['infrastructure', 's4s', "self-hosted", "linux", "x64", "amazon"]
    needs: migrate
    if: needs.migrate.outputs.is-valid == 'false'
    steps:
    - name: Download Validation Log
      uses: actions/download-artifact@v4
      with:
        name: migration-log

    - name: Notify Error
      uses: tecmise/actions/.github/actions/discord-notifier@v4.4.0
      with:
        title: '‚ùå  Houve um erro ao Executar Migration ‚ùå '
        message: "Falha ao executar migrations."
        severity: 'error'
        discord-webhook-url: "${{ secrets.DISCORD_NOTIFIER_URL }}"
        fields:
          name||"${{ inputs.name }}"
          table||"${{ inputs.flyway_table }}"

    - name: Send Log File
      run: |
        curl -X POST ${{ secrets.DISCORD_NOTIFIER_URL }} -F "file=@migration.log"

    - name: Throw Error
      run: |
        exit 1

  send-notification-migrate:
    name: Notify
    runs-on: ['infrastructure', 's4s', "self-hosted", "linux", "x64", "amazon"]
    needs: migrate
    if: needs.migrate.outputs.is-valid == 'true'
    steps:
    - name: Download Validation Log
      uses: actions/download-artifact@v4
      with:
        name: migration-log

    - name: Notify Error
      uses: tecmise/actions/.github/actions/discord-notifier@v4.4.0
      with:
        title: 'üöÄ Migration ${{ github.event.repository.name }} üöÄ'
        message: "Migra√ß√µes aplicadas com sucesso."
        severity: 'info'
        discord-webhook-url: "${{ secrets.DISCORD_NOTIFIER_URL }}"
        fields:
          name||"${{ inputs.name }}"
          table||"${{ inputs.flyway_table }}"

    - name: Send Log File
      run: |
        curl -X POST ${{ secrets.DISCORD_NOTIFIER_URL }} -F "file=@migration.log"