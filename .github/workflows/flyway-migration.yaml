name: Generate Connectors

on:
  workflow_call:
    secrets:
      database_password:
        required: true
      DISCORD_NOTIFIER_URL:
        required: true

    inputs:
      schema:
        description: 'Schema for the database'
        required: true
        type: string
      user:
        description: 'User for the database'
        required: true
        type: string
      endpoint:
        description: 'Endpoint for the connector'
        required: true
        type: string

jobs:
  validate-migrations:
    name: Validating Migrations
    runs-on: ['infrastructure', 's4s', "self-hosted", "linux", "x64", "amazon"]
    outputs:
      is-valid: "${{ steps.validate.outputs.exit_code == '0' }}"
      validated: "${{ steps.properties.outputs.validated }}"
    container:
      image: flyway/flyway:latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Validar SQLs com Flyway
      id: validate
      run: |
        ls -ltra
        echo "üîç Iniciando valida√ß√£o..."
        set +e
        VALIDATION_OUTPUT=$(flyway -url="jdbc:postgresql://${{ inputs.endpoint }}/permissions" \
          -user="${{ inputs.user }}" \
          -password="${{ secrets.database_password }}" \
          -schemas="${{ inputs.schema }}" \
          -ignoreMigrationPatterns="*:pending" \
          -connectRetries=60 \
          -locations="filesystem:./migrations" \
          validate 2>&1)
        EXIT_CODE=$?
        echo "$VALIDATION_OUTPUT" > validation.log
        echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

    - name: Instalar depend√™ncias
      run: |
        cat validation.log
        # Tentar instalar jq com apt-get (Debian/Ubuntu)
        if command -v apt-get &> /dev/null; then
          apt-get update && apt-get install -y jq
        # Tentar com yum (Red Hat/CentOS)
        elif command -v yum &> /dev/null; then
          yum install -y jq
        else
          echo "N√£o foi poss√≠vel instalar jq, usando alternativa"
          # Alternativa sem jq
          tail -n 20 validation.log > formatted_output.txt
          echo "validated=$(cat formatted_output.txt | sed 's/"/\\"/g' | tr '\n' ' ')" >> $GITHUB_OUTPUT
          exit 0
        fi

    - name: Loading
      id: properties
      run: |
        echo "validated=$(tail -n 20 validation.log | jq -Rs .)" >> $GITHUB_OUTPUT

  send-notification:
    name: Send Notification
    runs-on: ['infrastructure', 's4s', "self-hosted", "linux", "x64", "amazon"]
    needs: validate-migrations
    if: needs.validate-migrations.outputs.is-valid == 'false'
    steps:
    - name: Notify Success
      uses: tecmise/actions/.github/actions/discord-notifier@v3.0.4
      with:
        title: '‚ùå  Houve um erro ao validar migrations ‚ùå '
        message: "${{ steps.properties.outputs.validated }}"
        severity: 'error'
        discord-webhook-url: "${{ secrets.DISCORD_NOTIFIER_URL }}"